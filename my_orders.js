// ========= API-–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –æ–±—â–∏–µ –æ–±—ë—Ä—Ç–∫–∏ =========
const API = {
  KEY: "bc116b78-5671-4c27-82e8-386b5c51265d",
  URL: "https://edu.std-900.ist.mospolytech.ru/labs/api/",
};
let dishes = [];
let orders = [];

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
async function apiRequest(path, options = {}) {
  const url = `${API.URL}${path}${path.includes("?") ? "&" : "?"}api_key=${API.KEY}`;
  try {
    const response = await fetch(url, options);
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    return await response.json();
  } catch (error) {
    showToast({ message: "–û—à–∏–±–∫–∞ API: " + error.message, type: "error" });
    throw error;
  }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –±–ª—é–¥–∞
async function loadDishes() {
  dishes = await apiRequest("dishes");
  return dishes;
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadOrders() {
  orders = await apiRequest("orders");
  orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  return orders;
}

// –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
async function getOrder(orderId) {
  return await apiRequest(`orders/${orderId}`);
}

// –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
async function updateOrder(orderId, fields) {
  return await apiRequest(`orders/${orderId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(fields),
  });
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
async function deleteOrder(orderId) {
  return await apiRequest(`orders/${orderId}`, {
    method: "DELETE",
  });
}

// –î–ª—è –ø–æ–∏—Å–∫–∞ –±–ª—é–¥–∞ –ø–æ id
function getDishById(id) {
  return dishes.find((d) => d.id === id);
}

// ========= –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è =========
function showToast({ message, type = "success", duration = 2500 }) {
  let container = document.querySelector(".toasts");
  if (!container) {
    container = document.createElement("div");
    container.className = "toasts";
    document.body.appendChild(container);
  }
  const toast = document.createElement("div");
  toast.className = `toast show toast--${type}`;
  toast.innerHTML = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

// ========= –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ =========
function showModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.removeAttribute("hidden");
  document.body.style.overflow = "hidden";
}
function closeModal(id) {
  const modal = document.getElementById(id);
  if (modal) modal.setAttribute("hidden", "");
  document.body.style.overflow = "";
}
function closeAllModals() {
  document.querySelectorAll(".modal").forEach((m) => m.setAttribute("hidden", ""));
  document.body.style.overflow = "";
}

// ========= –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∑–∞–∫–∞–∑–∞ =========
function formatOrderItems(order) {
  const items = [];
  if (order.soup_id) items.push(getDishById(order.soup_id)?.name);
  if (order.main_course_id) items.push(getDishById(order.main_course_id)?.name);
  if (order.salad_id) items.push(getDishById(order.salad_id)?.name);
  if (order.drink_id) items.push(getDishById(order.drink_id)?.name);
  if (order.dessert_id) items.push(getDishById(order.dessert_id)?.name);
  return items.filter(Boolean).join(", ");
}
function formatTime(str) {
  // HTML time-picker –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 21:00, —Å–µ—Ä–≤–µ—Ä ‚Äî —Ç–æ–∂–µ, –≤–æ–∑–º–æ–∂–Ω–æ 09:00:00
  if (!str) return "";
  return str.length > 5 ? str.slice(0, 5) : str;
}
function formatDate(dt) {
  const d = new Date(dt);
  return d.toLocaleDateString("ru-RU") + " " +
      d.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
}
function formatDelivery(order) {
  if (order.delivery_type === "by_time" && order.delivery_time)
    return formatTime(order.delivery_time);
  return "–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ (—Å 07:00 –¥–æ 23:00)";
}

function getOrderTotal(order) {
  let total = 0;
  if (order.soup_id) {
    const soup = dishes.find(d => d.id === order.soup_id);
    if (soup) total += soup.price;
  }
  if (order.main_course_id) {
    const main = dishes.find(d => d.id === order.main_course_id);
    if (main) total += main.price;
  }
  if (order.salad_id) {
    const salad = dishes.find(d => d.id === order.salad_id);
    if (salad) total += salad.price;
  }
  if (order.drink_id) {
    const drink = dishes.find(d => d.id === order.drink_id);
    if (drink) total += drink.price;
  }
  if (order.dessert_id) {
    const dessert = dishes.find(d => d.id === order.dessert_id);
    if (dessert) total += dessert.price;
  }
  return total;
}


// ========= –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ =========
async function renderOrderList() {
  const tbody = document.querySelector(".orders-table tbody");
  tbody.innerHTML = "";
  orders.forEach((order, i) => {
    console.log(order);
    const tr = document.createElement("tr");
    tr.dataset.orderId = order.id;
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${formatDate(order.created_at)}</td>
      <td>${formatOrderItems(order)}</td>
      <td>${getOrderTotal(order)}‚ÇΩ</td>
      <td>${formatDelivery(order)}</td>
      <td class="orders-table__actions">
        <button class="icon-btn" data-action="view" aria-label="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">üëÅ</button>
        <button class="icon-btn" data-action="edit" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
        <button class="icon-btn icon-btn--danger" data-action="delete" aria-label="–£–¥–∞–ª–∏—Ç—å">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ========= –°–æ–±—ã—Ç–∏—è —Ç–∞–±–ª–∏—Ü—ã: –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ =========
document.querySelector(".orders-table tbody").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;
  const tr = btn.closest("tr");
  const orderId = tr?.dataset.orderId;
  if (!orderId) return;
  if (btn.dataset.action === "view") {
    await openViewModal(orderId);
  }
  if (btn.dataset.action === "edit") {
    await openEditModal(orderId);
  }
  if (btn.dataset.action === "delete") {
    await openDeleteModal(orderId);
  }
});

// ========= –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞ =========
async function openViewModal(orderId) {
  try {
    const order = await getOrder(orderId);
    document.querySelector("#modal-view .kv__row:nth-child(1) .kv__val").textContent = formatDate(order.created_at);
    document.querySelector("#modal-view .kv__row:nth-child(2) .kv__val").textContent = order.full_name;
    document.querySelector("#modal-view .kv__row:nth-child(3) .kv__val").textContent = order.delivery_address;
    document.querySelector("#modal-view .kv__row:nth-child(4) .kv__val").textContent = formatDelivery(order);
    document.querySelector("#modal-view .kv__row:nth-child(5) .kv__val").textContent = order.phone;
    document.querySelector("#modal-view .kv__row:nth-child(6) .kv__val").textContent = order.email;
    document.querySelector("#modal-view .kv__row:nth-child(7) .kv__val").textContent = order.comment || "-";
    // –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
    const list = document.querySelector("#modal-view .list");
    list.innerHTML = "";
    [
      { id: order.soup_id },
      { id: order.main_course_id },
      { id: order.salad_id },
      { id: order.drink_id },
      { id: order.dessert_id }
    ].forEach((d) => {
      if (d.id) {
        const dish = getDishById(d.id);
        if (dish) list.innerHTML += `<li>${dish.name} (${dish.price}‚ÇΩ)</li>`;
      }
    });
    document.querySelector("#modal-view .total strong").textContent = ` ${getOrderTotal(order)}‚ÇΩ`;
    showModal("modal-view");
  } catch (err) {
    showToast({ message: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞", type: "error" });
  }
}

// ========= –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ =========
let currentEditOrderId = null;
async function openEditModal(orderId) {
  try {
    const order = await getOrder(orderId);
    currentEditOrderId = orderId;
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
    document.getElementById("full_name").value = order.full_name;
    document.getElementById("email").value = order.email;
    document.getElementById("phone").value = order.phone;
    document.getElementById("delivery_address").value = order.delivery_address;
    document.getElementById("delivery_type").value = order.delivery_type === "by_time" ? "by_time" : "now";
    document.getElementById("delivery_time").value = order.delivery_time || "";
    document.getElementById("comment").value = order.comment || "";
    showModal("modal-edit");
  } catch (err) {
    showToast({ message: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", type: "error" });
  }
}


document.querySelector('#modal-edit .btn-primary').onclick = async function (e) {
  e.preventDefault();

  
const deliveryType = document.getElementById("delivery_type").value;
let deliveryTime = document.getElementById("delivery_time").value;

  const fields = {
    full_name: document.getElementById("full_name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    delivery_address: document.getElementById("delivery_address").value.trim(),
    delivery_type: deliveryType,
    comment: document.getElementById("comment").value.trim(),
  };

  if (deliveryType === "by_time") {
  if (!deliveryTime) {
    showToast({ message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏!", type: "error" });
    return;
  }
  fields.delivery_time = deliveryTime; // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å!
} else {
   if ('delivery_time' in fields) delete fields.delivery_time;
}
  try {
    await updateOrder(currentEditOrderId, fields);
    closeModal("modal-edit");
    showToast({ message: "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω", type: "success" });
    await refreshOrders();
  } catch (err) {
    showToast({ message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞", type: "error" });
  }
};
document.querySelector('#modal-edit .btn-secondary').onclick = () => closeModal("modal-edit");

// ========= –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ =========
let currentDeleteOrderId = null;
async function openDeleteModal(orderId) {
  currentDeleteOrderId = orderId;
  showModal("modal-delete");
}
document.querySelector('#modal-delete .btn-danger').onclick = async function () {
  try {
    await deleteOrder(currentDeleteOrderId);
    closeModal("modal-delete");
    showToast({ message: "–ó–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω", type: "success" });
    await refreshOrders();
  } catch (err) {
    showToast({ message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞", type: "error" });
  }
};
document.querySelector('#modal-delete .btn-secondary').onclick = () => closeModal("modal-delete");

// ========= –ö—Ä–µ—Å—Ç–∏–∫–∏ (–∑–∞–∫—Ä—ã—Ç–∏–µ) =========
document.querySelectorAll(".modal__close").forEach(btn => {
  btn.onclick = closeAllModals;
});
document.querySelectorAll(".modal__footer .btn").forEach(btn => {
  if (btn.dataset.action?.startsWith("close")) btn.onclick = closeAllModals;
});

// ========= –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ =========
async function refreshOrders() {
  await loadOrders();
  await renderOrderList();
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadDishes();
  await refreshOrders();
});
